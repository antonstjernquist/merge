# Merge

**Claude Code Agent Collaboration System**

Merge enables two Claude Code agents to collaborate via task delegation through a relay server. One agent (leader) sends tasks, the other (worker) executes and returns results.

## Architecture

```
┌─────────────────┐              ┌─────────────────┐
│  Agent A        │              │  Agent B        │
│  (Leader)       │              │  (Worker)       │
│  ┌───────────┐  │              │  ┌───────────┐  │
│  │ Claude    │  │              │  │ Claude    │  │
│  │ Code      │  │              │  │ Code      │  │
│  └─────┬─────┘  │              │  └─────┬─────┘  │
│        │        │              │        │        │
│  ┌─────▼─────┐  │              │  ┌─────▼─────┐  │
│  │ merge CLI │  │              │  │ merge CLI │  │
│  └───────────┘  │              │  └───────────┘  │
└────────┬────────┘              └────────┬────────┘
         │                                │
         │    ┌──────────────────────┐    │
         └───►│  Relay Server (VPS)  │◄───┘
              │  WebSocket + HTTP    │
              └──────────────────────┘
```

## Packages

| Package | Description |
|---------|-------------|
| [@merge/relay-server](./packages/relay-server) | Express + WebSocket server for task coordination |
| [@merge/cli](./packages/cli) | Command-line tool for agents to send/receive tasks |
| [@merge/shared-types](./packages/shared-types) | TypeScript interfaces shared between packages |
| [hooks](./packages/hooks) | Claude Code hooks for session awareness |

## Quick Start

### 1. Deploy the Relay Server

```bash
# Using the pre-built Docker image (recommended)
docker run -d \
  --name merge-relay \
  -p 3000:3000 \
  -e SHARED_TOKEN=your-secure-token \
  --restart unless-stopped \
  ghcr.io/antonstjernquist/merge/relay-server:latest
```

### 2. Install the CLI

```bash
# Clone and build
git clone https://github.com/antonstjernquist/merge.git
cd merge
pnpm install
pnpm build

# Link CLI globally
cd packages/cli
pnpm link --global
```

### 3. Connect Agents

**Terminal 1 (Leader):**
```bash
merge connect --token your-secure-token --name "Leader" --server http://your-vps:3000
merge send "Review the auth module for security issues" --blocking
```

**Terminal 2 (Worker):**
```bash
merge connect --token your-secure-token --name "Worker" --server http://your-vps:3000
merge poll
merge accept <task-id>
# ... do the work ...
merge result <task-id> --success --output "Found 2 issues: SQL injection in login(), missing rate limiting"
```

## How It Works

1. **Leader** creates a task via `merge send`
2. **Relay server** stores the task and notifies connected agents via WebSocket
3. **Worker** polls for tasks via `merge poll`, accepts one via `merge accept`
4. **Worker** completes the work and submits result via `merge result`
5. **Leader** receives the result (if `--blocking` was used, it waits automatically)

## Development

```bash
# Install dependencies
pnpm install

# Build all packages
pnpm build

# Run relay server in development mode
pnpm dev:relay

# Run tests
pnpm test
```

## Configuration

### Relay Server Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `SHARED_TOKEN` | `dev-token` | Authentication token for agents |
| `PORT` | `3000` | Server port |
| `HOST` | `0.0.0.0` | Server bind address |
| `SESSION_TIMEOUT_MS` | `3600000` | Session timeout in milliseconds (1 hour) |

### CLI Configuration

The CLI stores configuration in `~/.merge/config.yaml`:

```yaml
serverUrl: http://localhost:3000
wsUrl: ws://localhost:3000
token: your-token
agentId: <auto-generated>
agentName: Agent Name
```

## Security Considerations

- Use a strong, unique `SHARED_TOKEN` in production
- Deploy the relay server behind HTTPS (use a reverse proxy like nginx/caddy)
- The relay server is designed for a single pair of trusted agents
- Task content is not encrypted in transit beyond TLS

## License

MIT
